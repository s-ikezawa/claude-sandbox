# 実践例：変更内容からコミットメッセージ生成まで

このセクションでは、実際の`git diff`出力からコミットメッセージを生成するまでの完全なプロセスを示す。

**用語の定義**: このドキュメントでは、以下の用語を使用します。詳細は [SKILL.md](../SKILL.md) を参照してください。
- **開発者**: このスキルを使用してコミットメッセージを生成する人（AIが対話する相手）
- **ユーザー**: ソフトウェアのエンドユーザー（開発者が作成するアプリケーションを使用する人）

## 基本的なコミットメッセージ

まず、基本的なコミットメッセージの例を示します。

### 最もシンプルな形式
```text
feat: ユーザー認証機能を追加
```

### スコープを含む形式
```text
fix(api): ユーザー情報取得時のnullエラーを修正
```

### 本文を含む形式
```text
feat: ダークモード対応を追加

ユーザー設定でライトモードとダークモードを切り替えられるようにした。
システムの設定に従う自動モードもサポートしている。

Refs: #456
```

### 破壊的変更を示す形式
```text
feat(api)!: レスポンス形式を変更

BREAKING CHANGE: APIのレスポンス形式をRESTからGraphQLに変更した。
既存のクライアントは新しいGraphQLクエリ形式に更新する必要がある。
```

### 技術用語を含む形式
```text
fix(deps): パッケージの脆弱性を修正

lodashをv4.17.21にアップデートしてCVE-2021-23337を修正した。

Closes: #789
```

---

## 例1：テストのみの変更の場合

### git statusの出力
```text
new file:   tests/utils/validator.test.ts
```

### git diffの概要
- `validator.test.ts`: メールアドレス検証関数のテストケースを追加（50行追加）

### 分析
- 変更内容：既存の検証関数に対する新しいテストケースの追加
- 変更理由：エッジケースのカバレッジを向上させるため
- タイプ：テスト追加（`test`）
- スコープ：validator

### 生成されるコミットメッセージ
```text
test(validator): メールアドレス検証のテストケースを追加

エッジケース（特殊文字、複数のドット、長いドメイン名）の
テストカバレッジを追加した。
```

### 説明
この例では、既存のコードに対する新しいテストのみを追加しています。
- **タイプは `test`**: 既存機能の検証を目的としたテストの追加
- **本文で詳細を説明**: どのようなテストケースを追加したかを明記
- テストのみの変更は、機能追加でもバグ修正でもないため、独立したコミットとして扱う

---

## 例2：バグ修正の場合

### git statusの出力
```text
modified:   src/services/userService.ts
```

### git diffの概要
- `userService.ts`: `getUserById`メソッドでIDを整数に変換する処理を追加（1行変更）

### 分析
- 変更内容：`getUserById`メソッドでIDを整数に変換
- 変更理由：文字列として渡されたIDを適切に処理するため
- タイプ：バグ修正（`fix`）
- スコープ：userService

### 生成されるコミットメッセージ
```text
fix(user): getUserByIdで文字列IDを整数に変換

IDが文字列として渡された場合にユーザーが見つからない問題を修正した。
```

## 例3：新機能追加の場合

### git statusの出力
```text
new file:   src/components/DarkModeToggle.tsx
modified:   src/contexts/ThemeContext.tsx
modified:   src/App.tsx
```

### git diffの概要
- `DarkModeToggle.tsx`: 新しいトグルコンポーネント（100行追加）
- `ThemeContext.tsx`: ダークモードの状態管理を追加（30行追加）
- `App.tsx`: トグルコンポーネントを統合（5行追加）

### 分析
- 変更内容：ダークモード機能の追加
- 影響範囲：複数ファイルだが、すべて1つの機能に関連
- タイプ：新機能（`feat`）
- スコープ：theme

### 生成されるコミットメッセージ
```text
feat(theme): ダークモード機能を追加

ユーザーがライトモードとダークモードを切り替えられる機能を追加した。
- DarkModeToggleコンポーネントを実装
- ThemeContextにダークモード状態を追加
- ヘッダーにトグルボタンを配置

ユーザー設定はlocalStorageに保存される。
```

## 例4：複数の変更タイプを含む場合

### シナリオ

git statusの出力:
```text
modified:   src/api/auth.ts
modified:   README.md
new file:   tests/auth.test.ts
```

変更内容の分析:
- `auth.ts`: バグ修正（nullチェックの追加）
- `README.md`: ドキュメント更新
- `auth.test.ts`: テスト追加

**判断**: 複数の異なるタイプの変更が含まれており、それぞれが独立している。コミットを3つに分割すべきである。

**詳細な判断基準**: [execution-phases.md - 複数の変更を含む場合の処理](execution-phases.md#9-複数の変更を含む場合の処理) を参照

### AIの処理フロー

1. **開発者に確認**:
   ```text
   変更内容を分析した結果、以下の独立した変更が検出されました：
   1. fix(auth): バグ修正 - nullチェックの追加
   2. test(auth): テスト追加 - 認証機能のユニットテスト
   3. docs: ドキュメント更新 - 認証設定手順

   これらを3つの個別のコミットに分割することを推奨します。
   分割してコミットしますか？
   ```

2. **開発者が承認した場合**、以下の3つのコミットメッセージを生成し提示:

### 生成されるコミットメッセージ

**コミット1: バグ修正**
```text
fix(auth): ユーザートークンのnullチェックを追加

トークンがnullの場合のエラーハンドリングを追加した。
```

**コミット2: テスト追加**
```text
test(auth): 認証機能のユニットテストを追加

認証機能のテストカバレッジを追加した。
```

**コミット3: ドキュメント更新**
```text
docs: 認証設定手順を更新

認証設定手順をREADMEに追加した。
```

### 実行コマンド

ユーザーが「実行して」と指示した場合、以下のコマンドを順次実行:

```bash
# コミット1
git add src/api/auth.ts
git commit -m "$(cat <<'EOF'
fix(auth): ユーザートークンのnullチェックを追加

トークンがnullの場合のエラーハンドリングを追加した。
EOF
)"

# コミット2
git add tests/auth.test.ts
git commit -m "$(cat <<'EOF'
test(auth): 認証機能のユニットテストを追加

認証機能のテストカバレッジを追加した。
EOF
)"

# コミット3
git add README.md
git commit -m "$(cat <<'EOF'
docs: 認証設定手順を更新

認証設定手順をREADMEに追加した。
EOF
)"

# 最終確認
git status
```

**注意**: HEREDOCの使い方については [execution-phases.md - HEREDOCを使用したコミット実行方法](execution-phases.md#heredocを使用したコミット実行方法) を参照

## 例5：関連する変更をまとめる場合

### git statusの出力
```text
modified:   src/utils/validator.ts
new file:   tests/validator.test.ts
```

### git diffの概要
- `validator.ts`: バグ修正（メールアドレス検証ロジックの修正）
- `validator.test.ts`: 上記バグ修正に対応するテストケースの追加

### 分析
- 変更内容：メールアドレス検証のバグ修正とそのテスト追加
- 関連性：テストはバグ修正に直接関連しており、同じissueに紐づく
- 判断：**関連性があるため1つのコミットにまとめる**

### タイプの決定
- バグ修正が主な変更内容であるため、タイプは `fix` を使用
- テストはバグ修正に付随するものなので、本文で言及する

### 生成されるコミットメッセージ
```text
fix(validator): メールアドレス検証の正規表現を修正

特殊文字を含むメールアドレスが誤って拒否される問題を修正した。
RFC 5322準拠の正規表現に更新し、対応するテストケースを追加した。

変更内容：
- 正規表現パターンを更新
- エッジケースのテストを追加

Fixes: #456
```

### 説明
この例では、バグ修正とテストが密接に関連しているため、1つのコミットにまとめています。
- **タイプは `fix`**: バグ修正が主な変更内容
- **本文でテスト追加を説明**: 変更の全体像を把握しやすくする
- **フッターでissueを参照**: バグ報告とコミットを紐付ける

**逆のケース**（分割すべき場合）：
- バグ修正とは無関係な新しいバリデーターのテストを追加した場合
- その場合は `fix` と `test` の2つのコミットに分割する

## 例6：破壊的変更の場合

### git statusの出力
```text
modified:   src/api/v1/users.ts
new file:   src/api/v2/users.ts
modified:   src/api/index.ts
new file:   MIGRATION.md
modified:   README.md
```

### git diffの概要
- `v1/users.ts`: v1を非推奨としてマーク
- `v2/users.ts`: 新しいGraphQL形式のAPIを追加（100行追加）
- `index.ts`: v2エンドポイントをエクスポート（5行追加）
- `MIGRATION.md`: マイグレーション手順を記載（新規ファイル）
- `README.md`: API仕様の変更を反映（20行変更）

### 分析
- 変更内容：REST APIからGraphQL APIへの移行
- 破壊的変更：既存のREST APIクライアントが影響を受ける
- タイプ：新機能の追加（`feat`）+ 破壊的変更（`!`）
- スコープ：api

### 生成されるコミットメッセージ
```text
feat(api)!: レスポンス形式をGraphQLに変更

従来のREST APIからGraphQL APIに移行した。
v1 APIは非推奨となり、将来のバージョンで削除される予定。

新機能：
- GraphQLエンドポイント（/api/v2/graphql）を追加
- スキーマベースのクエリとミューテーション
- より柔軟なデータ取得が可能

BREAKING CHANGE: APIのレスポンス形式が変更されました。
既存のクライアントは新しいGraphQLクエリ形式に更新する必要があります。

マイグレーション手順：
1. GraphQLクライアントライブラリをインストール
   npm install @apollo/client graphql
2. REST APIの呼び出しをGraphQLクエリに置き換え
3. 詳細はMIGRATION.mdを参照

v1 APIは6ヶ月間サポートされます。

Refs: #789
```

### 説明
この例では、破壊的変更を含む大きな機能変更を扱っています。
- **タイプは `feat!`**: 新機能の追加だが、破壊的変更を含むため `!` を付ける
- **`BREAKING CHANGE:` フッターを使用**: 詳細な影響範囲と対応方法を記載
- **マイグレーション手順を明記**: ユーザーが対応しやすいよう具体的な手順を提供
- **サポート期限を明示**: v1 APIの廃止予定を明確にする
- **本文で新機能も説明**: 破壊的変更だけでなく、追加された価値も伝える

**重要なポイント**：
- `!` 記号は必須（タイプとスコープの直後、コロンの直前）
- `BREAKING CHANGE:` フッターで詳細を説明（推奨）
- マイグレーション手順やサポート期限など、ユーザーが必要とする情報を提供
- issueやPR番号を参照して、詳細な議論を追跡可能にする
